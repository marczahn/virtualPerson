---
phase: 01-biological-foundation
plan: "06"
type: tdd
wave: 4
depends_on:
  - "01-04"
  - "01-05"
files_modified:
  - v2/bio/engine_test.go
autonomous: true
requirements:
  - BIO-03
  - BIO-04

must_haves:
  truths:
    - "10 minutes of unattended simulation (600 ticks at dt=1.0, multiplier=1.0) shows Energy degraded by at least 0.2 from baseline"
    - "10 minutes unattended shows Hunger risen by at least 0.2 from baseline"
    - "10 minutes unattended shows no variable outside its valid range"
    - "Slow-path degradation outpaces recovery: running decay-only for 60 ticks produces measurably different state than starting state"
    - "Fast mode (DecayMultiplier=5.0): same degradation visible in 2 minutes (120 ticks at dt=1.0)"
  artifacts:
    - path: "v2/bio/engine_test.go"
      provides: "Scenario-based integration tests for Engine.Tick over many ticks"
      exports: ["TestEngine_TenMinutesUnattended", "TestEngine_FastMode_TwoMinutes", "TestEngine_AllVariablesInRange", "TestEngine_DtZero_NoDecay"]
  key_links:
    - from: "v2/bio/engine_test.go"
      to: "v2/bio/engine.go"
      via: "NewEngineWithSeed for deterministic test runs"
      pattern: "NewEngineWithSeed"
---

<objective>
Write and run scenario-based integration tests for the Engine using TDD, validating the phase success criteria: degradation accumulates over time, variables stay in range, and fast mode is demonstrably faster.

Purpose: The phase success criteria require observable degradation over time — this can only be validated by running the full Engine.Tick pipeline across many ticks. The 10-minute scenario is the primary acceptance test for Phase 1.
Output: v2/bio/engine_test.go with scenario tests; all tests green.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-biological-foundation/01-CONTEXT.md
@.planning/phases/01-biological-foundation/01-RESEARCH.md
@.planning/phases/01-biological-foundation/01-04-SUMMARY.md
@.planning/phases/01-biological-foundation/01-05-SUMMARY.md
</context>

<feature>
  <name>Engine scenario tests</name>
  <files>v2/bio/engine_test.go</files>
  <behavior>
Scenario tests run the full Engine.Tick pipeline over realistic time spans and assert measurable outcomes. Use `NewEngineWithSeed(cfg, 42)` for determinism. All tests use `package bio` (same package).

**Test cases:**

1. `TestEngine_TenMinutesUnattended`:
   - Config: DefaultConfig() with DecayMultiplier=1.0 (override from default 5.0)
   - State: NewDefaultState()
   - Run: 600 ticks, dt=1.0 each (simulates 10 minutes)
   - Assert: s.Energy <= initialEnergy - 0.2 (at least 0.2 drop from 0.8)
   - Assert: s.Hunger >= initialHunger + 0.2 (at least 0.2 rise from 0.1)
   - Assert: s.CognitiveCapacity <= 1.0 (capacity doesn't exceed max)
   - Assert: s.Mood <= initialMood (mood drifts down or stays flat)

2. `TestEngine_FastMode_TwoMinutes`:
   - Config: DefaultConfig() (DecayMultiplier=5.0)
   - State: NewDefaultState()
   - Run: 120 ticks, dt=1.0 each (simulates 2 minutes at 5x speed = 10 real minutes equivalent)
   - Assert: s.Energy <= initialEnergy - 0.2 (same degradation in 1/5 the ticks)
   - Assert: s.Hunger >= initialHunger + 0.2

3. `TestEngine_AllVariablesInRange`:
   - Config: DefaultConfig() with DecayMultiplier=5.0
   - State: NewDefaultState()
   - Run: 3000 ticks, dt=1.0 (simulates 50 minutes fast mode = extreme stress)
   - Assert all variables in range after every tick OR check just at end:
     - s.Energy in [0, 1]
     - s.Stress in [0, 1]
     - s.CognitiveCapacity in [0, 1]
     - s.Mood in [0, 1]
     - s.PhysicalTension in [0, 1]
     - s.Hunger in [0, 1]
     - s.SocialDeficit in [0, 1]
     - s.BodyTemp in [25, 43]

4. `TestEngine_DtZero_NoDecay`:
   - Config: DefaultConfig() with DecayMultiplier=1.0
   - State: NewDefaultState()
   - snapshot initial values
   - Run: 10 ticks, dt=0.0
   - Assert: s.Energy within 0.01 of initial (noise adds tiny variation, but no decay)
   - Assert: s.Hunger within 0.01 of initial
   - NOTE: noise still runs at dt=0 (ApplyNoise returns early at dt<=0, confirmed by noise.go)
   - So at dt=0, decay=0 AND noise=0 AND interactions=0 — state should be EXACTLY unchanged (modulo floating point). Assert exact equality or very tight epsilon.

5. `TestEngine_ThresholdsDetectedDuringDegradation`:
   - Config: use DecayMultiplier=10.0 to accelerate
   - State: set Energy=0.04 directly (just below 0.05 Critical threshold)
   - Run: 5 ticks, dt=1.0
   - Assert: at least one tick returns TickResult with len(Thresholds) > 0
   - Assert: the threshold event has Severity=Critical (for energy near-collapse)

Commit messages:
- RED: `test(01-06): add failing scenario tests for engine degradation over time`
- GREEN: `feat(01-06): engine passes all degradation scenario tests`
  </behavior>
  <implementation>
Use `package bio` test package (same package, internal access). Import only `testing` and `math` (for Abs if needed). Do not use external test helpers. Each test is self-contained — no shared state between tests. Use `NewEngineWithSeed(cfg, 42)` for all tests to ensure determinism.

For `TestEngine_AllVariablesInRange`: loop 3000 ticks checking ranges after each tick — if any variable goes out of range, call `t.Fatalf` immediately with the tick number and variable value. This catches transient violations, not just final state.

RED phase: write all test functions. All should compile but some may fail if implementation has edge cases. Run `go test ./bio/... -run TestEngine -v` to see failures.
GREEN phase: if any test fails, investigate the implementation — fix decay rates or pipeline ordering. Do NOT weaken test assertions to make tests pass.
REFACTOR: add t.Logf of final state values in scenario tests for diagnostics.
  </implementation>
</feature>

<verification>
Run `cd v2 && go test ./bio/... -v -count=1` — all tests pass. Run `cd v2 && go test ./bio/... -run TestEngine_TenMinutesUnattended -v` specifically and confirm the output shows Energy dropped and Hunger rose. Run `cd v2 && go test ./bio/... -race` — no data races.
</verification>

<success_criteria>
engine_test.go exists; all 5 scenario tests pass; 10-minute degradation test confirms phase success criteria 1 and 2 from ROADMAP; AllVariablesInRange test confirms BIO-06 holds under 50 minutes of extreme stress; no data races; `go test ./bio/... -race` clean.
</success_criteria>

<output>
After completion, create `.planning/phases/01-biological-foundation/01-06-SUMMARY.md`
</output>
