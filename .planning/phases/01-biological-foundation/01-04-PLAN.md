---
phase: 01-biological-foundation
plan: "04"
type: tdd
wave: 3
depends_on:
  - "01-02"
  - "01-03"
files_modified:
  - v2/bio/state_test.go
  - v2/bio/decay_test.go
  - v2/bio/interactions_test.go
  - v2/bio/thresholds_test.go
autonomous: true
requirements:
  - BIO-05
  - BIO-06

must_haves:
  truths:
    - "All bio variable ranges are enforced — no field can exceed its max or go below its min under any input"
    - "Decay rates produce visible degradation within the calibrated time windows"
    - "Interaction rules fire exactly when their condition is met — not before, not after"
    - "Threshold tiers return correct severity and only the most severe event per variable group"
    - "dt=0 produces zero decay and zero interaction deltas"
  artifacts:
    - path: "v2/bio/state_test.go"
      provides: "Unit tests for State, NewDefaultState, clamp, clampAll"
      exports: ["TestNewDefaultState_Baselines", "TestClampAll_EnforcesRanges", "TestClamp_AllVariables"]
    - path: "v2/bio/decay_test.go"
      provides: "Unit tests for ApplyDecay rates and dt-scaling"
      exports: ["TestApplyDecay_EnergyDrains", "TestApplyDecay_NoTouchStressOrTension", "TestApplyDecay_DtCap"]
    - path: "v2/bio/interactions_test.go"
      provides: "Unit tests for individual interaction rules and snapshot pattern"
      exports: ["TestInteractions_StressCausesPhysicalTension", "TestInteractions_SnapshotPreventsExplosion"]
    - path: "v2/bio/thresholds_test.go"
      provides: "Unit tests for threshold detection, severity, and cascade effects"
      exports: ["TestThresholds_SteppedTierOnlyMostSevere", "TestThresholds_CascadeApplied", "TestThresholds_BodyTemp"]
  key_links:
    - from: "v2/bio/state_test.go"
      to: "v2/bio/state.go"
      via: "tests exported NewDefaultState, clampAll"
      pattern: "bio\\.NewDefaultState"
    - from: "v2/bio/decay_test.go"
      to: "v2/bio/decay.go"
      via: "tests ApplyDecay with known dt values"
      pattern: "bio\\.ApplyDecay"
---

<objective>
Write and run unit tests for the bio state model, decay, interactions, and threshold components using TDD RED-GREEN-REFACTOR cycle.

Purpose: These components have well-defined inputs and outputs (perfect TDD candidates). Tests lock in the contracts: decay rates, clamp behavior, threshold detection logic. They also cover BIO-05 indirectly by verifying that noise application (via clampAll after noise) doesn't escape ranges — and BIO-06 directly via clampAll tests.
Output: 4 test files covering state, decay, interactions, and thresholds; all tests green.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-biological-foundation/01-CONTEXT.md
@.planning/phases/01-biological-foundation/01-RESEARCH.md
@.planning/phases/01-biological-foundation/01-01-SUMMARY.md
@.planning/phases/01-biological-foundation/01-02-SUMMARY.md
@.planning/phases/01-biological-foundation/01-03-SUMMARY.md
</context>

<feature>
  <name>Bio unit tests: state, decay, interactions, thresholds</name>
  <files>v2/bio/state_test.go, v2/bio/decay_test.go, v2/bio/interactions_test.go, v2/bio/thresholds_test.go</files>
  <behavior>
Each test file validates one component. All tests use table-driven format where possible (multiple cases as []struct{...}).

**state_test.go cases:**
- NewDefaultState returns correct baselines (Energy=0.8, Stress=0.1, CognitiveCapacity=1.0, Mood=0.5, PhysicalTension=0.05, Hunger=0.1, SocialDeficit=0.0, BodyTemp=36.6)
- clampAll: Energy=-0.5 → clamped to 0; Energy=1.5 → clamped to 1
- clampAll: BodyTemp=20.0 → clamped to 25; BodyTemp=50.0 → clamped to 43
- clampAll: Hunger=-0.1 → 0; Hunger=1.5 → 1
- clampAll: all 8 variables tested at both bounds

**decay_test.go cases:**
- ApplyDecay dt=1.0: Energy decreases from 0.8; Hunger increases from 0.1
- ApplyDecay dt=0.0: all 5 decay variables unchanged (zero decay at dt=0)
- ApplyDecay dt=1.0: Stress unchanged from 0.1 (no autonomous decay)
- ApplyDecay dt=1.0: PhysicalTension unchanged from 0.05
- ApplyDecay dt=1.0: BodyTemp unchanged from 36.6
- ApplyDecay dt=100.0 (above cap): result identical to dt=60.0 (cap enforced)
- Decay rate calibration: at DecayMultiplier=1.0, dt=240.0, Energy should decrease by ~0.16 from baseline (0.00067*240≈0.161)

**interactions_test.go cases:**
- High stress (>0.6) causes PhysicalTension to increase
- High stress (>0.5) depletes CognitiveCapacity
- Low energy (<0.3) depresses Mood
- Compound rule 21: low energy + high hunger causes additional Mood drop
- Snapshot pattern: mutating state mid-rule-evaluation does not affect condition checking (rule 1 fires, PhysicalTension changes, but rule 9 "PhysicalTension>0.7" evaluates against pre-tick snapshot, not the changed value)
- dt=0: all deltas are zero

**thresholds_test.go cases:**
- Stress=0.96 → Critical event returned (not just Mild)
- Stress=0.72 → Mild event returned (not Warning)
- Stress=0.50 → no Stress threshold event
- BodyTemp=32.0 → exactly 1 event, Severity=Critical (not 3 events)
- BodyTemp=34.5 → exactly 1 event, Severity=Mild (not Warning)
- BodyTemp=36.6 (baseline) → no BodyTemp threshold event
- Energy=0.04 → Critical event
- Hunger=0.96 → Critical event
- ApplyThresholdCascades: Critical stress event cascade (Mood-=, Energy-=) applied correctly to State
  </behavior>
  <implementation>
Use standard Go testing package. Test file package declaration: `package bio` (same package, allows access to unexported helpers if needed). Each test function named `Test{Component}_{Scenario}`. Use `t.Errorf` with descriptive format strings including actual vs expected values. Do not use t.Fatal except at setup. No test helper dependencies beyond stdlib testing.

RED phase: write ALL test functions first (they will fail because implementations exist but edge cases may be wrong). Verify failures with `go test ./bio/... -run TestXxx -v`.
GREEN phase: fix any implementation issues found. All tests must pass.
REFACTOR: ensure test code is clean and no redundancy.

Commit messages:
- RED: `test(01-04): add failing unit tests for bio state, decay, interactions, thresholds`
- GREEN: `feat(01-04): fix implementations to pass all unit tests`
  </implementation>
</feature>

<verification>
Run `cd v2 && go test ./bio/... -v` — all tests must pass. Zero failures. Run `cd v2 && go test ./bio/... -count=1` to avoid cache.
</verification>

<success_criteria>
All 4 test files exist; `go test ./bio/...` passes with 0 failures; table-driven tests cover all boundary cases for clamp, decay rates, interaction conditions, and threshold tiers.
</success_criteria>

<output>
After completion, create `.planning/phases/01-biological-foundation/01-04-SUMMARY.md`
</output>
