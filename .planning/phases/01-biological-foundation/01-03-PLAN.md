---
phase: 01-biological-foundation
plan: "03"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - v2/bio/thresholds.go
autonomous: true
requirements:
  - BIO-07

must_haves:
  truths:
    - "EvaluateThresholds returns ThresholdEvents for every variable crossing a tier boundary"
    - "Critical stress (>0.95) fires a ThresholdEvent with Severity=Critical and cascade deltas"
    - "ThresholdEvent cascade deltas can be applied to *State via ApplyThresholdCascades"
    - "TerminalStates=false (default) does NOT prevent threshold detection — only clamps cascade effects"
  artifacts:
    - path: "v2/bio/thresholds.go"
      provides: "Three-tier threshold system with cascade bio effects"
      exports: ["Severity", "ThresholdEvent", "EvaluateThresholds", "ApplyThresholdCascades", "ThresholdConfig"]
  key_links:
    - from: "v2/bio/thresholds.go"
      to: "v2/bio/state.go"
      via: "EvaluateThresholds reads *State, ApplyThresholdCascades mutates *State"
      pattern: "func EvaluateThresholds\\(s \\*State"
---

<objective>
Implement the three-tier threshold system: detect critical bio conditions (mild/warning/critical), surface them as ThresholdEvents with descriptive information, and apply cascade bio effects when thresholds are crossed.

Purpose: Thresholds are the alarm system — they detect when variables reach dangerous territory and trigger physiological cascade responses (e.g., critical stress → mood collapse + cognitive depletion). The motivation layer and consciousness layer use these events to understand what the person is experiencing.
Output: v2/bio/thresholds.go
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-biological-foundation/01-CONTEXT.md
@.planning/phases/01-biological-foundation/01-RESEARCH.md
@.planning/phases/01-biological-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement threshold detection with cascades</name>
  <files>v2/bio/thresholds.go</files>
  <action>
Create `v2/bio/thresholds.go` with package `bio`. Implements BIO-07: detect critical bio conditions and surface them with cascade effects.

**Severity type:**
```go
package bio

// Severity represents the urgency level of a threshold crossing.
type Severity int

const (
    Mild     Severity = iota // noticeable but manageable
    Warning                  // impairs function, attention required
    Critical                 // dangerous, demands immediate response
)

func (s Severity) String() string {
    switch s {
    case Mild:     return "mild"
    case Warning:  return "warning"
    case Critical: return "critical"
    default:       return "unknown"
    }
}
```

**ThresholdEvent type:**
```go
// ThresholdEvent describes a bio variable that has crossed a threshold tier.
// Cascade contains the bio effects triggered by this crossing.
// Cascade effects must be applied via ApplyThresholdCascades after clampAll.
type ThresholdEvent struct {
    Variable    string    // bio variable name (e.g., "stress", "body_temp")
    Severity    Severity
    Description string    // human-readable condition description
    Cascade     []Delta   // bio effects triggered by this threshold crossing
}
```

**ThresholdConfig:**
```go
// ThresholdConfig controls threshold behavior.
// TerminalStatesEnabled=false (development default) does not suppress detection —
// it only prevents cascade effects from driving variables toward lethal extremes
// by capping cascade magnitudes.
type ThresholdConfig struct {
    TerminalStatesEnabled bool // false = development default
}

func DefaultThresholdConfig() ThresholdConfig {
    return ThresholdConfig{TerminalStatesEnabled: false}
}
```

**EvaluateThresholds:** Evaluates state against all threshold conditions and returns events. This is called AFTER clampAll (step 5 of tick pipeline). Cascade deltas are returned inside the events, not applied here — the engine applies them and re-clamps.

Implement the following threshold checks exactly as specified in RESEARCH.md:

**Body Temperature thresholds:**
- BodyTemp < 35.0: Mild, "Mild hypothermia, shivering", Cascade: PhysicalTension += 0.2
- BodyTemp < 34.0: Warning, "Moderate hypothermia, mental slowing", Cascade: PhysicalTension += 0.3, CognitiveCapacity -= 0.2
- BodyTemp < 33.0: Critical, "Severe hypothermia, crisis", Cascade: Stress += 0.3, CognitiveCapacity -= 0.4
- BodyTemp > 38.5: Mild, "Elevated temperature, discomfort", Cascade: Stress += 0.1, CognitiveCapacity -= 0.1
- BodyTemp > 39.5: Warning, "Fever, significant impairment", Cascade: Stress += 0.2, Mood -= 0.2
- BodyTemp > 40.5: Critical, "Dangerous hyperthermia", Cascade: Stress += 0.4, CognitiveCapacity -= 0.3

**Stress thresholds (dt-scaled cascades — these fire every tick the condition persists):**
- Stress > 0.7: Mild, "Elevated stress", Cascade: PhysicalTension += 0.01 * dt
- Stress > 0.85: Warning, "High stress, impaired function", Cascade: CognitiveCapacity -= 0.02 * dt, Mood -= 0.01 * dt
- Stress > 0.95: Critical, "Crisis state", Cascade: Mood -= 0.03 * dt, Energy -= 0.02 * dt

**Energy thresholds (dt-scaled):**
- Energy < 0.3: Mild, "Low energy, effort costs more", Cascade: CognitiveCapacity -= 0.01 * dt
- Energy < 0.15: Warning, "Very low energy", Cascade: Mood -= 0.01 * dt, Stress += 0.01 * dt
- Energy < 0.05: Critical, "Near physical collapse", Cascade: Stress += 0.03 * dt, CognitiveCapacity -= 0.03 * dt

**Hunger thresholds (dt-scaled):**
- Hunger > 0.7: Mild, "Noticeably hungry", Cascade: Mood -= 0.005 * dt
- Hunger > 0.85: Warning, "Very hungry, difficulty focusing", Cascade: CognitiveCapacity -= 0.01 * dt, Stress += 0.005 * dt
- Hunger > 0.95: Critical, "Starving", Cascade: Stress += 0.02 * dt, Energy -= 0.01 * dt

**Threshold detection logic:** For stepped tiers (e.g., BodyTemp has mild <35, warning <34, critical <33), only emit the MOST SEVERE applicable event — not all three. For a temp of 32°C, emit only Critical, not Mild + Warning + Critical.

**EvaluateThresholds signature:**
```go
func EvaluateThresholds(s *State, cfg ThresholdConfig, dt float64) []ThresholdEvent
```

**ApplyThresholdCascades:** Applies cascade deltas from all events to state. Called by engine after receiving events, then engine calls clampAll again.
```go
// ApplyThresholdCascades applies the cascade Deltas from all threshold events to s.
// After calling this, clampAll must be called to keep values in range.
func ApplyThresholdCascades(s *State, events []ThresholdEvent) {
    for _, e := range events {
        for _, d := range e.Cascade {
            applyDelta(s, d)
        }
    }
}
```

Note: `applyDelta` is defined in interactions.go — both files are in the same package `bio`, so it's accessible.

**TerminalStatesEnabled behavior:** When false, threshold events are still detected and returned. The cascade effects are still applied. The only difference is that cascade effects which would push a variable toward a lethal extreme (e.g., body temp below 30°C) are capped by clampAll. Terminal states "enabled" would mean allowing variables to reach 0 energy, 0 mood, 43°C body temp without any artificial floor. Since clampAll always enforces ranges, TerminalStatesEnabled=false effectively just means the game never kills the simulation. The flag is reserved for future use — implement the detection logic identically regardless of the flag value for now, but include the field in ThresholdConfig for future use.
  </action>
  <verify>Run `cd v2 && go build ./bio/...`. Verify `EvaluateThresholds` and `ApplyThresholdCascades` are exported. Check that for BodyTemp=32.0 the function returns exactly 1 event (Critical, not 3 events). Run `cd v2 && go vet ./bio/...`.</verify>
  <done>thresholds.go compiles; Severity type with 3 values (Mild/Warning/Critical); ThresholdEvent with Cascade []Delta; EvaluateThresholds covers all 4 variable groups (BodyTemp, Stress, Energy, Hunger); most-severe-only logic for stepped tiers; ApplyThresholdCascades applies deltas.</done>
</task>

</tasks>

<verification>
- `cd v2 && go build ./bio/...` exits 0
- `cd v2 && go vet ./bio/...` exits 0
- `Severity` has String() method returning "mild"/"warning"/"critical"
- `ThresholdEvent` has Variable, Severity, Description, Cascade fields
- `EvaluateThresholds` takes (s *State, cfg ThresholdConfig, dt float64) and returns []ThresholdEvent
- `ApplyThresholdCascades` takes (s *State, events []ThresholdEvent)
- Stepped tier detection: only most-severe event per variable group emitted
- BodyTemp range triggers: <35.0, <34.0, <33.0 (hypothermia), >38.5, >39.5, >40.5 (hyperthermia)
</verification>

<success_criteria>
thresholds.go compiles; three severity tiers implemented for Body Temp, Stress, Energy, Hunger; cascade effects defined; most-severe-only detection logic; ApplyThresholdCascades wires events to state mutation.
</success_criteria>

<output>
After completion, create `.planning/phases/01-biological-foundation/01-03-SUMMARY.md`
</output>
